<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµé‡ç›‘æ§é¢æ¿ (Port 7788)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        .card { 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            border: none; 
            transition: transform 0.2s, box-shadow 0.2s; 
            margin-bottom: 1.5rem;
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .stat-label { font-size: 0.9rem; opacity: 0.8; }
        #realtime-chart-container, #history-chart-container { height: 400px; width: 100%; }
        .badge-status { font-size: 0.8rem; padding: 0.5em 0.8em; }
        .navbar { box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-speedometer2"></i> SS æµé‡ç›‘æ§ <span id="current-port-display">(Port 7788)</span>
            </a>
            <div class="d-flex align-items-center">
                <!-- System Stats -->
                <div class="text-light me-3 d-none d-md-block font-monospace" style="font-size: 0.85rem;">
                    <span title="CPU Usage"><i class="bi bi-cpu"></i> <span id="cpu-usage">0%</span></span>
                    <span class="mx-2">|</span>
                    <span title="Memory Usage"><i class="bi bi-memory"></i> <span id="mem-usage">0%</span></span>
                </div>

                <!-- Port Selector -->
                <div class="dropdown me-3">
                    <button class="btn btn-outline-light dropdown-toggle btn-sm" type="button" id="portDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        åˆ‡æ¢ç«¯å£
                    </button>
                    <ul class="dropdown-menu" id="port-list" aria-labelledby="portDropdown">
                        <!-- Ports will be loaded here -->
                        <li><a class="dropdown-item" href="#">åŠ è½½ä¸­...</a></li>
                    </ul>
                </div>
                
                <button class="btn btn-light btn-sm me-3" onclick="promptAddPort()">
                    <i class="bi bi-plus-lg"></i>
                </button>

                <button class="btn btn-outline-light btn-sm" onclick="toggleTheme()">
                    <i class="bi bi-moon-stars-fill" id="theme-icon"></i>
                </button>
                
                <div class="dropdown ms-2">
                    <button class="btn btn-outline-light btn-sm" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item text-danger" href="#" onclick="resetCurrentPortData()">ğŸ—‘ï¸ é‡ç½®å½“å‰ç«¯å£æ•°æ®</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- çŠ¶æ€å’Œè¿æ¥æ•° -->
        <div class="row mb-3">
             <div class="col-12">
                 <div class="card bg-light-subtle">
                     <div class="card-body py-2 d-flex justify-content-between align-items-center">
                         <div>
                             <span id="status-badge" class="badge bg-secondary badge-status me-2">æ£€æµ‹ä¸­...</span>
                             <span id="process-info" class="text-muted small"></span>
                         </div>
                         <div>
                             <span class="badge bg-info text-dark" title="æ´»è·ƒTCPè¿æ¥æ•°">
                                <i class="bi bi-diagram-2"></i> è¿æ¥æ•°: <span id="conn-count">0</span>
                             </span>
                         </div>
                     </div>
                 </div>
             </div>
        </div>

        <!-- å®æ—¶é€Ÿåº¦å¡ç‰‡ -->
        <div class="row">
            <div class="col-md-6">
                <div class="card border-start border-4 border-success">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2 text-success">â¬†ï¸ å®æ—¶ä¸Šä¼ é€Ÿåº¦</h6>
                            <div class="stat-value" id="speed-up">0 B/s</div>
                        </div>
                        <i class="bi bi-arrow-up-circle text-success fs-1 opacity-25"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-start border-4 border-primary">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="card-subtitle mb-2 text-primary">â¬‡ï¸ å®æ—¶ä¸‹è½½é€Ÿåº¦</h6>
                            <div class="stat-value" id="speed-down">0 B/s</div>
                        </div>
                        <i class="bi bi-arrow-down-circle text-primary fs-1 opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ•°æ®å¡ç‰‡ -->
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stat-label">ä»Šæ—¥ä¸Šä¼ </div>
                        <div class="stat-value text-success" id="today-up">0 B</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stat-label">ä»Šæ—¥ä¸‹è½½</div>
                        <div class="stat-value text-primary" id="today-down">0 B</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stat-label">æ€»è®¡ä¸Šä¼ </div>
                        <div class="stat-value text-success" id="total-up">0 B</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stat-label">æ€»è®¡ä¸‹è½½</div>
                        <div class="stat-value text-primary" id="total-down">0 B</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åœ¨çº¿æ—¶é•¿ -->
        <div class="row">
            <div class="col-12">
                 <div class="card bg-light-subtle">
                    <div class="card-body d-flex justify-content-around align-items-center">
                        <div class="text-center">
                            <i class="bi bi-clock-history text-warning fs-4 mb-1 d-block"></i>
                            <span class="stat-label">ä»Šæ—¥åœ¨çº¿: </span>
                            <span class="fw-bold" id="today-time">0h 0m 0s</span>
                        </div>
                        <div class="vr"></div>
                        <div class="text-center">
                            <i class="bi bi-hourglass-split text-info fs-4 mb-1 d-block"></i>
                            <span class="stat-label">æ€»åœ¨çº¿: </span>
                            <span class="fw-bold" id="total-time">0h 0m 0s</span>
                        </div>
                    </div>
                 </div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-transparent fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-graph-up"></i> æµé‡è¶‹åŠ¿ (24h)</span>
                        <small class="text-muted fw-normal">1åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡</small>
                    </div>
                    <div class="card-body">
                        <div id="realtime-chart-container">
                            <canvas id="trafficChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-transparent fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-bar-chart-fill"></i> å†å²æ¯æ—¥æµé‡ (è¿‘7å¤©)</span>
                        <div>
                            <button class="btn btn-sm btn-outline-success me-1" onclick="exportCSV()" title="å¯¼å‡ºCSV">
                                <i class="bi bi-file-earmark-spreadsheet"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="updateHistoryData()">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="history-chart-container">
                            <canvas id="historyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Port Modal -->
    <div class="modal fade" id="addPortModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ·»åŠ ç›‘æ§ç«¯å£</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPortForm" onsubmit="submitAddPort(event)">
                        <div class="mb-3">
                            <label for="portInput" class="form-label">ç«¯å£å· (1-65535)</label>
                            <input type="number" class="form-control" id="portInput" required min="1" max="65535" placeholder="ä¾‹å¦‚: 80, 443, 3306">
                            <div class="form-text">è¯·ç¡®ä¿è¯¥ç«¯å£å·²è¢«æœåŠ¡å ç”¨ï¼Œå¦åˆ™æ— æ³•ç»Ÿè®¡æµé‡ã€‚</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="submitAddPort()">ç¡®å®šæ·»åŠ </button>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿæ—¥å¿— -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-transparent fw-bold">
                        <i class="bi bi-terminal"></i> ç³»ç»Ÿäº‹ä»¶æ—¥å¿—
                    </div>
                    <div class="card-body p-0">
                        <div id="log-container" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                            <!-- Logs here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPort = 7788; // Default

        // Load Ports on Init
        fetchPorts();

        function fetchPorts() {
            fetch('/api/ports')
                .then(res => res.json())
                .then(ports => {
                    const list = document.getElementById('port-list');
                    list.innerHTML = '';
                    
                    if (ports.length > 0 && !ports.includes(currentPort)) {
                        currentPort = ports[0]; // Auto switch if current deleted
                    }
                    
                    updatePortDisplay();

                    ports.forEach(port => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center px-2">
                                <a class="dropdown-item flex-grow-1" href="#" onclick="switchPort(${port})">Port ${port}</a>
                                <button class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="deletePort(${port}, event)" title="åˆ é™¤">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `;
                        list.appendChild(li);
                    });
                });
        }

        function switchPort(port) {
            currentPort = port;
            updatePortDisplay();
            // Reset Charts
            trafficChart.data.labels = [];
            trafficChart.data.datasets[0].data = [];
            trafficChart.data.datasets[1].data = [];
            trafficChart.update();
            
            // Trigger updates
            updateData();
            updateSeriesData();
            updateHistoryData();
        }

        function updatePortDisplay() {
            document.getElementById('current-port-display').textContent = `(Port ${currentPort})`;
        }

        let addPortModal;
        function promptAddPort() {
            if (!addPortModal) {
                addPortModal = new bootstrap.Modal(document.getElementById('addPortModal'));
            }
            document.getElementById('portInput').value = '';
            addPortModal.show();
        }

        function submitAddPort(event) {
            if (event) event.preventDefault();
            
            const portInput = document.getElementById('portInput');
            const port = portInput.value;
            
            if (port) {
                fetch('/api/ports', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({port: port})
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // alert(data.message); // Optional: silent success
                        if (addPortModal) addPortModal.hide();
                        fetchPorts();
                        // Auto switch to new port
                        setTimeout(() => switchPort(port), 500); 
                    } else {
                        alert("é”™è¯¯: " + data.message);
                    }
                })
                .catch(err => alert("ç½‘ç»œé”™è¯¯: " + err));
            }
        }

        function deletePort(port, event) {
            event.stopPropagation(); // Prevent dropdown closing or switching
            if (confirm(`ç¡®å®šè¦åœæ­¢ç›‘æ§ç«¯å£ ${port} å—ï¼Ÿå†å²æ•°æ®å°†ä¿ç•™ã€‚`)) {
                fetch(`/api/ports/${port}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        fetchPorts();
                    } else {
                        alert(data.message);
                    }
                });
            }
        }

        function resetCurrentPortData() {
            if (confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ¸…ç©ºç«¯å£ ${currentPort} çš„æ‰€æœ‰æµé‡ç»Ÿè®¡å’Œå†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                fetch(`/api/stats/${currentPort}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert("æ•°æ®å·²é‡ç½®");
                        switchPort(currentPort); // Refresh
                    } else {
                        alert("é‡ç½®å¤±è´¥: " + data.message);
                    }
                });
            }
        }

        function updateSystemStats() {
            fetch('/api/system')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('cpu-usage').textContent = `${data.cpu_percent.toFixed(1)}%`;
                    document.getElementById('mem-usage').textContent = `${data.memory_percent.toFixed(1)}%`;
                })
                .catch(err => console.error(err));
        }
        setInterval(updateSystemStats, 2000);
        updateSystemStats();

        function exportCSV() {
            window.location.href = `/api/export/${currentPort}`;
        }

        function updateLogs() {
            fetch('/api/logs')
                .then(res => res.json())
                .then(logs => {
                    const container = document.getElementById('log-container');
                    container.innerHTML = '';
                    logs.forEach(log => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item list-group-item-action py-2';
                        item.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <small class="text-muted">${log.time}</small>
                                <small class="fw-bold text-primary">${log.source}</small>
                            </div>
                            <p class="mb-0 small">${log.message}</p>
                        `;
                        container.appendChild(item);
                    });
                });
        }
        setInterval(updateLogs, 3000);
        updateLogs();

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-bs-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-bs-theme', next);
            
            const icon = document.getElementById('theme-icon');
            if (next === 'dark') {
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-stars-fill';
            }
            
            // æ›´æ–°å›¾è¡¨é¢œè‰²é€‚é…ä¸»é¢˜
            updateChartTheme(next);
        }

        function updateChartTheme(theme) {
            const color = theme === 'dark' ? '#adb5bd' : '#666';
            const gridColor = theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            [trafficChart, historyChart].forEach(chart => {
                if (chart) {
                    chart.options.scales.x.ticks.color = color;
                    chart.options.scales.y.ticks.color = color;
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.plugins.legend.labels.color = color;
                    chart.update();
                }
            });
        }

        // æ ¼å¼åŒ–å·¥å…·
        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h}h ${m}m ${s}s`;
        }

        // å®æ—¶å›¾è¡¨åˆå§‹åŒ– (æ”¹ä¸º24å°æ—¶è¶‹åŠ¿)
        const ctx = document.getElementById('trafficChart').getContext('2d');
        const trafficChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'ä¸Šä¼  (KB/s)',
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        data: [],
                        fill: true,
                        tension: 0.2,
                        pointRadius: 0,
                        borderWidth: 1.5
                    },
                    {
                        label: 'ä¸‹è½½ (KB/s)',
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        data: [],
                        fill: true,
                        tension: 0.2,
                        pointRadius: 0,
                        borderWidth: 1.5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { 
                        display: true,
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 8,
                            maxRotation: 0
                        }
                    }
                }
            }
        });

        // å†å²å›¾è¡¨åˆå§‹åŒ–
        const ctxHistory = document.getElementById('historyChart').getContext('2d');
        const historyChart = new Chart(ctxHistory, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'ä¸Šä¼ ',
                        backgroundColor: 'rgba(25, 135, 84, 0.7)',
                        data: []
                    },
                    {
                        label: 'ä¸‹è½½',
                        backgroundColor: 'rgba(13, 110, 253, 0.7)',
                        data: []
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return formatBytes(value); }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatBytes(context.raw);
                            }
                        }
                    }
                }
            }
        });

        // æ•°æ®æ›´æ–°é€»è¾‘
        function updateData() {
            fetch(`/api/stats/${currentPort}`)
                .then(response => response.json())
                .then(data => {
                    // æ•°å€¼æ›´æ–°
                    document.getElementById('speed-up').textContent = formatBytes(data.current_speed_up) + '/s';
                    document.getElementById('speed-down').textContent = formatBytes(data.current_speed_down) + '/s';
                    
                    document.getElementById('today-up').textContent = formatBytes(data.today_upload);
                    document.getElementById('today-down').textContent = formatBytes(data.today_download);
                    document.getElementById('total-up').textContent = formatBytes(data.total_upload);
                    document.getElementById('total-down').textContent = formatBytes(data.total_download);
                    
                    document.getElementById('today-time').textContent = formatTime(data.today_online_seconds);
                    document.getElementById('total-time').textContent = formatTime(data.total_online_seconds);

                    // çŠ¶æ€æ›´æ–°
                    const badge = document.getElementById('status-badge');
                    const procInfo = document.getElementById('process-info');
                    const connCount = document.getElementById('conn-count');

                    connCount.textContent = data.connections || 0;

                    if (data.active_pids && data.active_pids.length > 0) {
                        badge.className = 'badge bg-success badge-status me-2';
                        badge.textContent = `ğŸŸ¢ è¿è¡Œä¸­`;
                        
                        // Show process names
                        let names = data.process_names || [];
                        if (names.length > 0) {
                             procInfo.textContent = `è¿›ç¨‹: ${names.join(', ')} (PID: ${data.active_pids.join(', ')})`;
                        } else {
                             procInfo.textContent = `PID: ${data.active_pids.join(', ')}`;
                        }
                    } else {
                        badge.className = 'badge bg-danger badge-status me-2';
                        badge.textContent = 'ğŸ”´ æœªæ£€æµ‹åˆ°è¿›ç¨‹';
                        procInfo.textContent = '';
                    }

                    // å®æ—¶å›¾è¡¨æ›´æ–° (Series)
                    // ä¸å†å®æ—¶pushï¼Œè€Œæ˜¯ä»/api/seriesè·å–å®Œæ•´æ•°æ®ï¼ˆæ¯åˆ†é’Ÿæˆ–æ¯5ç§’ï¼‰
                })
                .catch(err => console.error('Stats fetch error:', err));
        }

        function updateSeriesData() {
            fetch(`/api/series/${currentPort}`)
                .then(response => response.json())
                .then(data => {
                    const labels = data.map(item => item.time);
                    const ups = data.map(item => item.up / 1024);
                    const downs = data.map(item => item.down / 1024);
                    
                    trafficChart.data.labels = labels;
                    trafficChart.data.datasets[0].data = ups;
                    trafficChart.data.datasets[1].data = downs;
                    trafficChart.update();
                })
                .catch(err => console.error('Series fetch error:', err));
        }

        function updateHistoryData() {
            fetch(`/api/history/${currentPort}`)
                .then(response => response.json())
                .then(data => {
                    // å¤„ç†æ•°æ®ï¼Œå–æœ€è¿‘7å¤©
                    const dates = Object.keys(data).sort().slice(-7);
                    const uploads = dates.map(d => data[d].upload);
                    const downloads = dates.map(d => data[d].download);

                    historyChart.data.labels = dates;
                    historyChart.data.datasets[0].data = uploads;
                    historyChart.data.datasets[1].data = downloads;
                    historyChart.update();
                })
                .catch(err => console.error('History fetch error:', err));
        }

        // å¯åŠ¨å¾ªç¯
        setInterval(updateData, 1000);
        updateData();
        
        // è¶‹åŠ¿æ•°æ®æ¯5ç§’åˆ·æ–°ä¸€æ¬¡ (å®é™…ä¸Šåç«¯æ˜¯æ¯åˆ†é’Ÿç”Ÿæˆä¸€ä¸ªç‚¹)
        updateSeriesData();
        setInterval(updateSeriesData, 5000);

        // å†å²æ•°æ®æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ï¼Œæˆ–é¡µé¢åŠ è½½æ—¶åˆ·æ–°
        updateHistoryData();
        setInterval(updateHistoryData, 60000);
    </script>
</body>
</html>
